#!/bin/sh
set -e

PKGNAME="r4vk-speedtest"

ETC_DIR="/var/packages/${PKGNAME}/etc"
CONFIG_FILE="${ETC_DIR}/config.env"

if [ -f "${CONFIG_FILE}" ]; then
  . "${CONFIG_FILE}"
fi

HOST_PORT="${HOST_PORT:-8000}"

do_start() {
  # Docker lifecycle is handled by DSM resource worker via conf/resource.
  exit 0
}

do_stop() {
  # Docker lifecycle is handled by DSM resource worker via conf/resource.
  exit 0
}

do_status() {
  # Basic health check over localhost.
  if command -v curl >/dev/null 2>&1; then
    curl -fsS "http://127.0.0.1:${HOST_PORT}/healthz" >/dev/null 2>&1 && exit 0
  elif command -v wget >/dev/null 2>&1; then
    wget -qO- "http://127.0.0.1:${HOST_PORT}/healthz" >/dev/null 2>&1 && exit 0
  fi
  exit 1
}

case "$1" in
  start) do_start ;;
  stop) do_stop ;;
  status) do_status ;;
  *) echo "Usage: $0 {start|stop|status}" >&2; exit 1 ;;
esac
